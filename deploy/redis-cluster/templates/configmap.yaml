apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "redis-cluster.name" . }}
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "redis-cluster.labels" . | nindent 4 }}
data:
  redis.conf: |
    # Redis Cluster 配置
    bind 0.0.0.0
    port {{ .Values.redis.cluster.port }}

    dir /data

    # 启用集群模式
    cluster-enabled yes
    cluster-config-file nodes.conf
    cluster-node-timeout 5000
    cluster-require-full-coverage no

    # 持久化配置
    save 900 1
    save 300 10
    save 60 10000
    rdbcompression yes
    dbfilename dump.rdb

    # AOF配置
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync everysec

    # 安全配置
    requirepass {{ .Values.redis.cluster.password }}
    masterauth {{ .Values.redis.cluster.password }}

    # 集群总线配置
    cluster-announce-ip $POD_IP
    cluster-announce-port {{ .Values.redis.cluster.port }}
    cluster-announce-bus-port {{ .Values.redis.cluster.clusterBusPort }}
